<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Particle Toy</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <script src="bundle.js"></script>
    <script>
        function Microphone (_fft) {

            var FFT_SIZE = _fft || 1024;

            this.spectrum = [];
            this.volume = this.vol = 0;
            this.peak_volume = 0;

            var self = this;
            var audioContext = new AudioContext();
            var SAMPLE_RATE = audioContext.sampleRate;

            // this is just a browser check to see
            // if it supports AudioContext and getUserMedia
            window.AudioContext = window.AudioContext ||  window.webkitAudioContext;
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;

            // now just wait until the microphone is fired up
            window.addEventListener('load', init, false);

            function init () {
                try {
                    startMic(new AudioContext());
                }
                catch (e) {
                    console.error(e);
                    alert('Web Audio API is not supported in this browser');
                }
            }

            function startMic (context) {

                navigator.getUserMedia({ audio: true }, processSound, error);

                function processSound (stream) {

                    // analyser extracts frequency, waveform, etc.
                    var analyser = context.createAnalyser();
                    analyser.smoothingTimeConstant = 0.2;
                    analyser.fftSize = FFT_SIZE;

                    var node = context.createScriptProcessor(FFT_SIZE*2, 1, 1);

                    node.onaudioprocess = function () {

                        // bitcount returns array which is half the FFT_SIZE
                        self.spectrum = new Uint8Array(analyser.frequencyBinCount);

                        // getByteFrequencyData returns amplitude for each bin
                        analyser.getByteFrequencyData(self.spectrum);
                        // getByteTimeDomainData gets volumes over the sample time
                        // analyser.getByteTimeDomainData(self.spectrum);

                        self.vol = self.getRMS(self.spectrum);
                        // get peak - a hack when our volumes are low
                        if (self.vol > self.peak_volume) self.peak_volume = self.vol;
                        self.volume = self.vol;

                    };

                var input = context.createMediaStreamSource(stream);
                input.connect(analyser);
                analyser.connect(node);
                node.connect(context.destination);

            }

            function error () {
                console.log(arguments);
            }

        }

        return this;

    };

        var Mic = new Microphone();
    </script>
    <canvas id="mainCanvas"></canvas>
    <div class="sliders">
        Left click to attract. Right click to repel. Have fun!
        <ul>
            <li>
                <input type="range" min="0" max="100" value="15" class="slider" id="accel">
                Acceleration: <span id="accelVal"></span>
            </li>
            <li>
                <input type="range" min="0" max="100" value="60" class="slider" id="points">
                Points: <span id="pointsVal"></span>
            </li>
            <li>
                <input type="range" min="1" max="10" value="0.5" class="slider" id="pointsize">
                Point Size: <span id="pointsizeVal"></span>
            </li>
            <li>
                <input type="checkbox" class="slider" id="screensaver">
                Screensaver Mode <span id="auto run"></span>
            </li>
        </ul>

    </div>
    <div id="glerror">
        <h1>Error: Could not load WebGL 2</h1>
        <h2>This site needs WebGL 2. Your browser doesn't seem to support it. Try a recent version of Chrome</h2>
    </div>
</body>

</html>